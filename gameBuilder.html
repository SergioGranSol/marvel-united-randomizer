<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Marvel United Randomizer</title>
  <script type="text/javascript" src="./static/libs/dexie/js/dexie.js"></script>
  <script type="text/javascript" src="./static/libs/element-creator/js/element-creator.min.js"></script>
  <script type="text/javascript" src="./static/libs/tabler/js/tabler.min.js"></script>
  <script type="text/javascript" src="./static/libs/dom-to-image/js/dom-to-image.min.js"></script>
  <script type="text/javascript" src="./static/libs/FileSaver/js/FileSaver.min.js"></script>
  <script type="text/javascript" src="./static/js/config/constants.js"></script>
  <script type="text/javascript" src="./static/js/config/config-db.js"></script>
  <script type="text/javascript" src="./static/js/utils/game-utils.js"></script>
  <script type="text/javascript" src="./static/js/utils/utils.js"></script>
  <script type="text/javascript" src="./static/js/models/repository.js"></script>
  <script type="text/javascript" src="./static/js/models/service.js"></script>
  <script type="text/javascript" src="./static/js/controllers/page-controller.js"></script>
  <script type="text/javascript" src="./static/js/game-card-builder.js"></script>
  <link rel="stylesheet" type="text/css" href="./static/libs/fontawesome-free-6.2.0-web/css/all.min.css" />
  <link rel="stylesheet" type="text/css" href="./static/libs/tabler/css/tabler.min.css" />
  <link rel="stylesheet" type="text/css" href="./static/css/customs-mur.css" />
  <link rel="shorcut icon" type="image/png" href="./static/img/logo.png">
</head>

<body class="layout-boxed">
  <div class="page bg-dots">
    <div class="page-body">
      <div class="row p-5 pb-0 fst-game">
        <div class="col-auto">
          <div class="logo">
            <div class="logo-container">
              <a href="./index.html">
                <img src="./static/img/logo.png" alt="Marvel United">
              </a>
            </div>
          </div>
        </div>
        <div class="col">
          <h1 class="fst-game-title mb-2 ms-3 page-title"> Marvel United <br> Randomizer </h1>
        </div>
      </div>
      <div class="row g-0 my-2 me-4">
        <div class="col bg-primary-game text-white text-shadow ps-3 py-1 fst-game-title fs-1 label-title border border-5 border-black border-start-0 border-end-0"> Game settings </div>
        <div class="col-auto border border-5 border-black border-start-0 border-top-0 border-end-0">
          <img src="./static/img/labelBorder-game.png" alt="labelBorder" class="label-border label-border-game">
        </div>
        <div class="col-12 bg-primary-game text-white text-shadow ps-3 py-1 fst-game-title fs-1 label-title border border-5 border-black border-top-0 border-start-0 bg-blue h-1"> </div>
      </div>
      <div class="mx-5">
        <div class="position-relative">
          <div class="border-double bg-secondary-game p-2">
            <div class="row">
              <div class="col-md-6 col-sm-12">
                <div class="border-3 border-start border-red ps-2 fst-game fw-bold"> Mode: </div>
                <hr class="my-1">
                <select class="form-select form-select-sm border-black border-2 fst-game fw-bold mb-2" name="modes" onchange="cleanFrom(this);">
                  <option class="fw-bold" value="-1" selected> Select a mode</option>
                </select>
              </div>
              <div class="col-md-6 col-sm-12">
                <div class="border-3 border-start border-red ps-2 fst-game fw-bold"> Challenge: </div>
                <hr class="my-1">
                <select class="form-select form-select-sm border-black border-2 fst-game fw-bold mb-2" name="challenges">
                  <option class="fw-bold" value="-1" selected> No challenge</option>
                </select>
              </div>
              <div class="col-md-6 col-sm-12">
                <div class="border-3 border-start border-red ps-2 fst-game fw-bold"> Locations ( 6 ): </div>
                <hr class="my-1">
                <div class="input-group mb-1">
                  <div class="dropdown-menu overflow-y-scroll mb-2 w-100 selected-values" data-set="locations"></div>
                  <div class="border border-2 border-bottom-0 form-control border-black rounded-0 w-100 pb-1 px-2" data-set-values="locations" data-max-values="6"></div>
                  <button type="button" class="form-select form-select-sm border-2 border-top-0 border-end-0 border-black bg-white rounded-0 fst-game fw-bold text-start" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Select locations
                  </button>
                  <select class="form-select form-select-sm border-black border-top-0 border-start-0 border-2 rounded-0 bg-white fst-game fw-bold" name="locationNumber">
                    <option value="1"> as location 1</option>
                    <option value="2"> as location 2</option>
                    <option value="3"> as location 3</option>
                    <option value="4"> as location 4</option>
                    <option value="5"> as location 5</option>
                    <option value="6"> as location 6</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6 col-sm-12">
                <div class="border-3 border-start border-red ps-2 fst-game fw-bold"> Initial location: </div>
                <hr class="my-1">
                <div class="form-selectgroup mb-1">
                  <label class="form-selectgroup-item">
                    <input type="radio" name="initLocation" value="1" class="form-selectgroup-input" checked="">
                    <span class="form-selectgroup-label avatar rounded-0 border-2 border-black input-option d-inline-flex fst-game fw-bold fs-5">1</span>
                  </label>
                  <label class="form-selectgroup-item">
                    <input type="radio" name="initLocation" value="2" class="form-selectgroup-input">
                    <span class="form-selectgroup-label avatar rounded-0 border-2 border-black input-option d-inline-flex fst-game fw-bold fs-5">2</span>
                  </label>
                  <label class="form-selectgroup-item">
                    <input type="radio" name="initLocation" value="3" class="form-selectgroup-input">
                    <span class="form-selectgroup-label avatar rounded-0 border-2 border-black input-option d-inline-flex fst-game fw-bold fs-5">3</span>
                  </label>
                  <label class="form-selectgroup-item">
                    <input type="radio" name="initLocation" value="4" class="form-selectgroup-input">
                    <span class="form-selectgroup-label avatar rounded-0 border-2 border-black input-option d-inline-flex fst-game fw-bold fs-5">4</span>
                  </label>
                  <label class="form-selectgroup-item">
                    <input type="radio" name="initLocation" value="5" class="form-selectgroup-input">
                    <span class="form-selectgroup-label avatar rounded-0 border-2 border-black input-option d-inline-flex fst-game fw-bold fs-5">5</span>
                  </label>
                  <label class="form-selectgroup-item">
                    <input type="radio" name="initLocation" value="6" class="form-selectgroup-input">
                    <span class="form-selectgroup-label avatar rounded-0 border-2 border-black input-option d-inline-flex fst-game fw-bold fs-5">6</span>
                  </label>
                </div>
              </div>
              <div class="col-12" data-game-builder-section="villains">
                <div class="border-3 border-start border-red ps-2 fst-game fw-bold"> Villains ( <span data-max-values-label="villains">_</span> ): </div>
                <hr class="my-1">
                <div class="input-group mb-1">
                  <div class="dropdown-menu overflow-y-scroll mb-2 w-100 selected-values" data-set="villains"></div>
                  <div class="border border-2 border-bottom-0 form-control border-black rounded-0 w-100 pb-1 px-2" data-set-values="villains" data-max-values="6"></div>
                  <button type="button" class="form-select form-select-sm border-2 border-top-0 border-end-0 border-black bg-white rounded-0 fst-game fw-bold text-start" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Select villain(s)
                  </button>
                  <select class="form-select form-select-sm border-black border-top-0 border-start-0 border-2 rounded-0 bg-white fst-game fw-bold" name="villainNumber">
                    <option value="1"> as villain 1</option>
                    <option value="2"> as villain 2</option>
                    <option value="3"> as villain 3</option>
                    <option value="4"> as villain 4</option>
                    <option value="5"> as villain 5</option>
                    <option value="6"> as villain 6</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6 col-sm-12">
                <div class="border-3 border-start border-red ps-2 fst-game fw-bold"> <span data-team-label="teamISize">Heroes</span> ( <span data-max-values-label="teamISize">_</span> ): </div>
                <hr class="my-1">
                <div class="input-group mb-1">
                  <div class="dropdown-menu overflow-y-scroll mb-2 w-100 selected-values" data-set="teamISize"></div>
                  <div class="border border-2 border-bottom-0 form-control border-black rounded-0 w-100 pb-1 px-2" data-set-values="teamISize" data-max-values="5"></div>
                  <button type="button" class="form-select form-select-sm border-2 border-top-0 border-end-0 border-black bg-white rounded-0 fst-game fw-bold text-start" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Select heroes
                  </button>
                  <select class="form-select form-select-sm border-black border-top-0 border-start-0 border-2 rounded-0 bg-white fst-game fw-bold" name="heroINumber">
                    <option value="1"> as hero 1</option>
                    <option value="2"> as hero 2</option>
                    <option value="3"> as hero 3</option>
                    <option value="4"> as hero 4</option>
                    <option value="5"> as hero 5</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6 col-sm-12">
                <div class="border-3 border-start border-red ps-2 fst-game fw-bold"> <span data-team-label="teamISize">Heroes</span> Companions ( <span data-max-values-label="companionsI">_</span> ): </div>
                <hr class="my-1">
                <div class="input-group mb-1">
                  <div class="dropdown-menu overflow-y-scroll mb-2 w-100 selected-values" data-set="companionsI"></div>
                  <div class="border border-2 border-bottom-0 form-control border-black rounded-0 w-100 pb-1 px-2" data-set-values="companionsI" data-max-values="4"></div>
                  <button type="button" class="form-select form-select-sm border-2 border-top-0 border-end-0 border-black bg-white rounded-0 fst-game fw-bold text-start" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Select companion(s)
                  </button>
                  <select class="form-select form-select-sm border-black border-top-0 border-start-0 border-2 rounded-0 bg-white fst-game fw-bold" name="heroCompanionINumber">
                    <option value="1"> for hero 1</option>
                    <option value="2"> for hero 2</option>
                    <option value="3"> for hero 3</option>
                    <option value="4"> for hero 4</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6 col-sm-12 d-none" data-game-builder-section="second-team">
                <div class="border-3 border-start border-red ps-2 fst-game fw-bold"> <span data-team-label="teamIISize">Second</span> Team ( <span data-max-values-label="teamIISize">_</span> ): </div>
                <hr class="my-1">
                <div class="input-group mb-1">
                  <div class="dropdown-menu overflow-y-scroll mb-2 w-100 selected-values" data-set="teamIISize"></div>
                  <div class="border border-2 border-bottom-0 form-control border-black rounded-0 w-100 pb-1 px-2" data-set-values="teamIISize" data-max-values="5"></div>
                  <button type="button" class="form-select form-select-sm border-2 border-top-0 border-end-0 border-black bg-white rounded-0 fst-game fw-bold text-start" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Select heroes
                  </button>
                  <select class="form-select form-select-sm border-black border-top-0 border-start-0 border-2 rounded-0 bg-white fst-game fw-bold" name="heroIINumber">
                    <option value="1"> as hero 1</option>
                    <option value="2"> as hero 2</option>
                    <option value="3"> as hero 3</option>
                    <option value="4"> as hero 4</option>
                    <option value="5"> as hero 5</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6 col-sm-12 d-none" data-game-builder-section="second-team">
                <div class="border-3 border-start border-red ps-2 fst-game fw-bold"> <span data-team-label="teamIISize">Second</span> Team Companions ( <span data-max-values-label="companionsII">_</span> ): </div>
                <hr class="my-1">
                <div class="input-group mb-1">
                  <div class="dropdown-menu overflow-y-scroll mb-2 w-100 selected-values" data-set="companionsII"></div>
                  <div class="border border-2 border-bottom-0 form-control border-black rounded-0 w-100 pb-1 px-2" data-set-values="companionsII" data-max-values="4"></div>
                  <button type="button" class="form-select form-select-sm border-2 border-top-0 border-end-0 border-black bg-white rounded-0 fst-game fw-bold text-start" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Select companion(s)
                  </button>
                  <select class="form-select form-select-sm border-black border-top-0 border-start-0 border-2 rounded-0 bg-white fst-game fw-bold" name="heroCompanionIINumber">
                    <option value="1"> for hero 1</option>
                    <option value="2"> for hero 2</option>
                    <option value="3"> for hero 3</option>
                    <option value="4"> for hero 4</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-12">
                <div id="errorMessage" class="alert bg-danger-lt border-2 border-danger rounded-0 my-1 d-none" role="alert">
                  <span class="fst-game fw-bold">Error message</span>
                </div>
              </div>
              <div class="col-12">
                <button class="btn btn-outline-red border-2 border-black rounded-0 w-100 mt-1 fst-game-title" onclick="getNewGame()"> Get game </button>
                <hr class="my-3">
                <div class="input-group">
                  <button class="btn btn-outline-orange border-2 border-black rounded-0 fst-game-title" type="button" onclick="getGameFromCode();">Get from code</button>
                  <input type="text" class="form-control border-2 border-black rounded-0 fst-game" placeholder="Battle code" name="codeInput">
                </div>
              </div>
            </div>
          </div>
          <img src="./static/img/corner-blue.png" alt="corner" class="top-0 end-0 corner corner-blue" style="transform: rotateY(180deg);">
          <img src="./static/img/corner-blue.png" alt="corner" class="bottom-0 start-0 corner corner-blue" style="transform: rotateX(180deg);">
        </div>
      </div>
    </div>
  </div>
  <div class="position-fixed top-0 start-0 vw-100 vh-100" id="loadingScreen">
    <div class="position-absolute top-50 start-50 translate-middle bg-blue border border-3 border-black rounded-3 p-3">
      <strong role="status" class="fst-game-title text-white text-shadow">Loading...</strong>
    </div>
  </div>

  <div class="modal modal-blur fade" id="modal-card" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header bg-dots bg-primary-game fst-game-title">
          <h2 class="modal-title text-white text-shadow fs-2">Card Game</h2>
          <button type="button" class="btn-close opacity-100" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-2">
          <div class="position-relative">
            <div class="border-double bg-secondary-game p-2">
              <div class="btn-group w-100" role="group">
                <button type="button" class="btn btn-outline-blue border-2 border-black rounded-0 fst-game-title" onclick="dowloadImage(this);">
                  Download card
                </button>
                <button type="button" class="btn btn-outline-cyan border-2 border-black rounded-0 fst-game-title" onclick="copyCode(this);">
                  Copy code
                </button>
              </div>
              <div id="warningsInGame" class="alert bg-yellow-lt border-2 border-yellow rounded-0 mt-3 fst-game d-none" role="alert">
                <p class="fw-bold">This setup does not match with the rules but it can be played. You maybe need and extra copy of some pieces.</p>
                <div>Warning here</div>
              </div>
              <div id="errorsInGame" class="alert bg-danger-lt border-2 border-danger rounded-0 mt-3 fst-game d-none" role="alert">
                <p class="fw-bold">This setup cannot be played.</p>
                <div>Errors here</div>
              </div>
              <div class="overflow-x-auto border border-2 border-black bg-muted mt-3 p-3 h-auto">
                <div id="cardGame" class="card bg-transparent card-container rounded-3">
                  <input type="text" class="d-none" name="card-code" value="">
                  <div class="ribbon ribbon-top card-ribbon bg-lime border border-4 border-top-0 border-black rounded-bottom-3 text-shadow fst-game-title me-3">
                    <div class="m-2 fs-1">
                      <i class="fa-solid fa-user mx-1"></i>
                      <span card-section="players"></span>
                      <hr class="border-2 border-black my-2 opacity-100">
                      <i card-section="is-valid" class="fa-solid fa-triangle-exclamation"></i>
                    </div>
                  </div>
                  <div class="card-body card-container bg-dots bg-secondary-game py-4 px-0 border border-2 rounded-2">
                    <div class="row g-0 my-3 label-title-margin">
                      <div class="col bg-primary-game text-white text-shadow ps-3 py-1 fst-game-title fs-1 label-title border border-5 border-black border-start-0 border-end-0">
                        Battle card
                      </div>
                      <div class="col-auto border border-5 border-black border-start-0 border-top-0 border-end-0">
                        <img src="./static/img/labelBorder-game.png" alt="labelBorder" class="label-border label-border-game">
                      </div>
                      <div class="col-12 bg-primary-game text-white text-shadow ps-3 py-1 fst-game-title fs-1 label-title border border-5 border-black border-top-0 border-start-0 bg-blue h-1"> </div>
                    </div>
                    <div class="bg-dots text-dark my-3 p-2 text-center fst-game fw-bold">
                      <span class="fst-game-title">Mode: </span>
                      <span card-section="card-description"></span>
                      <br>
                      <span class="fst-game-title">Battle code: </span>
                      <span card-section="code"></span>
                    </div>
                    <div class="card-table-game text-center mx-auto position-relative">
                      <table class="table table-sm table-bordered bg-secondary-game border-black border-double" aria-describedby="Card game">
                        <tbody>
                          <tr>
                            <th rowspan="6" scope="col" class="text-center border-3 p-0 cols-1-section" card-section="blue-team">
                              <div class="fst-game-title py-1 bg-primary-game text-white">Hero(es)</div>
                              <div class="row row-cols-1 justify-content-center g-0"></div>
                            </th>
                            <th rowspan="6" scope="col" class="text-center border-3 p-0 cols-1-section" card-section="red-team">
                              <div class="fst-game-title py-1 bg-primary-game text-white">Villain(s)</div>
                              <div class="row row-cols-1 justify-content-center g-0"></div>
                            </th>
                            <th rowspan="6" scope="col" class="text-center border-3 p-0 cols-1-section" card-section="yellow-team">
                              <div class="fst-game-title py-1 bg-primary-game text-white">Hero(es)</div>
                              <div class="row row-cols-1 justify-content-center g-0"></div>
                            </th>
                            <th scope="col" class="text-center border-3 p-0">
                              <div class="fst-game-title py-1 bg-primary-game text-white border border-3 border-x-0 border-top-0 border-black">Locations</div>
                              <div card-section="locations" class="row g-0 text-start fst-game fw-bold fs-4 p-2"></div>
                            </th>
                          </tr>
                          <tr>
                            <th scope="col" class="text-center border-3 p-0">
                              <div class="fst-game-title py-1 bg-primary-game text-white border border-3 border-x-0 border-top-0 border-black">Challenge</div>
                              <div card-section="challenge" class="fst-game fw-bold fs-4 py-2"></div>
                            </th>
                          </tr>
                          <tr class="border-bottom-0">
                            <th scope="col" class="text-center border-3 border-bottom-0 p-0">
                              <div class="fst-game-title py-1 bg-primary-game text-white border border-3 border-x-0 border-top-0 border-black">Team Decks</div>
                              <div class="row my-2">
                                <div class="col">
                                  <div class="fst-game-title text-blue" card-section="blue-team-inidicator">Blue team</div>
                                  <div card-section="blue-team-decks" class="fst-game fw-bold fs-4 px-2"></div>
                                </div>
                                <div class="col" card-section="red-team-optionals">
                                  <div class="fst-game-title text-red">Red team</div>
                                  <div card-section="red-team-decks" class="fst-game fw-bold fs-4 px-2"></div>
                                </div>
                                <div class="col" card-section="yellow-team-optionals">
                                  <div class="fst-game-title text-yellow">Yellow team</div>
                                  <div card-section="yellow-team-decks" class="fst-game fw-bold fs-4 px-2"></div>
                                </div>
                              </div>
                            </th>
                          </tr>
                        </tbody>
                      </table>
                      <img src="./static/img/corner-blue.png" alt="corner" class="top-0 start-0 corner corner-blue">
                      <img src="./static/img/corner-blue.png" alt="corner" class="top-0 end-0 corner corner-blue" style="transform: rotateY(180deg);">
                      <img src="./static/img/corner-blue.png" alt="corner" class="bottom-0 start-0 corner corner-blue" style="transform: rotateX(180deg);">
                      <img src="./static/img/corner-blue.png" alt="corner" class="bottom-0 end-0 corner corner-blue" style="transform: rotate(180deg);">
                      <div card-section="notes" class="fst-game fw-bold py-1 d-none"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <img src="./static/img/corner-blue.png" alt="corner" class="top-0 start-0 corner corner-blue">
            <img src="./static/img/corner-blue.png" alt="corner" class="bottom-0 end-0 corner corner-blue" style="transform: rotate(180deg);">
          </div>
        </div>
      </div>
    </div>
  </div>

</body>

<script>
  const pc = new PageController();
  const cb = new CardBuilder();
  const modalCard = new bootstrap.Modal('#modal-card');
  const screenCoverLoading = document.getElementById('loadingScreen');

  const buildPage = async () => {
    const inputOptions = {
      modes: { items: await pc.getAllModes(), selectElements: document.querySelectorAll('[name="modes"]') },
      challenges: { items: await pc.getAllChallenges(), selectElements: document.querySelectorAll('[name="challenges"]') },
      locations: { items: await pc.getAllLocations(), selectElements: document.querySelectorAll('[data-set="locations"]') },
      villains: { items: await pc.getAllVillainsForGames(), selectElements: document.querySelectorAll('[data-set="villains"]') },
      heores: { items: await pc.getAllHeroesForGames(), selectElements: document.querySelectorAll('[data-set^="team"]') },
      companiosn: { items: await pc.getAllCompanions(), selectElements: document.querySelectorAll('[data-set^="companions"]') }
    };

    for (const key in inputOptions) {
      for (const item of inputOptions[key].items) {
        for (const selectElement of inputOptions[key].selectElements) {
          if (key == 'modes') {
            let modeDescription = '';
            modeDescription += item.players > 1 ? ` (P${item.code.includes('(SX') || item.code.includes('(C') || item.code.includes('SXw') || item.code.includes('Cw') ? '1' : item.teamISize}` : '';
            modeDescription += item.players > 1 && item.teamIISize > 0 ? ` VS P${item.code.includes('vSX') || item.code.includes('vC') ? '1' : item.teamIISize}` : '';
            modeDescription += item.players > 1 && item.superVillainMode == 1 ? ' VS P1' : '';
            modeDescription += item.players > 1 ? ')' : '';
            selectElement.appendChild(elCr(`option[name=${key},value=${item.id},data-villains=${item.villains},data-team-i-size=${item.teamISize},data-team-i-i-size=${item.teamIISize},data-companions-i=${item.teamISize == 5 ? '1' : item.teamISize},data-companions-i-i=${item.teamIISize == 5 ? '1' : item.teamIISize}`, `P${item.players} - ${item.name + (` (P${item.players})` == modeDescription ? '' : modeDescription) }`));
          } else if (key == 'challenges') {
            selectElement.appendChild(elCr(`option[name=${key},value=${item.id}`, item.name));
          } else {
            selectElement.appendChild(elCr('label.dropdown-item.py-0.fst-game.fw-bold.fs-5', [
              elCr(`input.form-check-input.m-0.me-2.border.border-2.border-muted.rounded-0[type=checkbox,name=${selectElement.dataset.set},value=${item.id},onchange=setMultipleSelectValues(this);]`),
              elCr('span', item.name)
            ]));
          }
        }
      }
    }

    screenCoverLoading.classList.add('d-none');
  }

  const setMultipleSelectValues = (input) => {
    const values = document.querySelector(`[data-set-values="${input.name}"]`);
    const maxValues = Number(values.dataset.maxValues);
    const itemPosition = values.nextElementSibling.nextElementSibling;
    let auxText = '';
    const auxDataset = `data-position=${itemPosition.value},`;
    if (input.name == 'companionsI' || input.name == 'companionsII') {
      auxText = `Hero ${itemPosition.value} with ${input.nextElementSibling.textContent}`;
    } else if (input.name == 'teamISize' || input.name == 'teamIISize') {
      auxText = `${input.nextElementSibling.textContent} as hero ${itemPosition.value}`;
    } else if (input.name == 'locations') {
      auxText = `${input.nextElementSibling.textContent} as location ${itemPosition.value}`;
    } else if (input.name == 'villains') {
      auxText = `${input.nextElementSibling.textContent} as villain ${itemPosition.value}`;
    }

    if (values.childElementCount < maxValues && input.checked) {
      values.appendChild(
        elCr(`button.btn.badge.bg-white.border.border-2.border-blue.rounded-0.me-1.mb-1.fst-game-title.text-yellow[type=button,${auxDataset}data-id=${input.value},data-value=${input.name},onclick=removeSelection(this);]`, [
          auxText, elCr('i.fa-solid.fa-close.ms-2')
        ])
      );
      itemPosition.querySelector(`[value="${itemPosition.value}"]`).disabled = true;
    } else if (!input.checked) {
      const elementToRemove = values.querySelector(`[data-id="${input.value}"]`);
      itemPosition.querySelector(`[value="${elementToRemove.dataset.position}"]`).disabled = false;
      elementToRemove.remove();
    }
    checkSet(document.querySelectorAll(`[name="${input.name}"]`), values);
  }

  const removeSelection = (selectedValue) => {
    const value = document.querySelector(`[data-set="${selectedValue.dataset.value}"] [value="${selectedValue.dataset.id}"]`);
    value.checked = false;
    const values = document.querySelector(`[data-set-values="${selectedValue.dataset.value}"]`);
    const itemPosition = values.nextElementSibling.nextElementSibling;
    itemPosition.querySelector(`[value="${selectedValue.dataset.position}"]`).disabled = false;
    selectedValue.remove();
    checkSet(document.querySelectorAll(`[name="${selectedValue.dataset.value}"]`), values);
  }

  const checkSet = (valuesSet, values) => {
    const maxValues = Number(values.dataset.maxValues);
    for (const checkbox of valuesSet) {
      if (!checkbox.checked) {
        checkbox.disabled = values.childElementCount >= maxValues;
        if (values.childElementCount >= maxValues) {
          checkbox.nextElementSibling.classList.add('text-muted');
        } else {
          checkbox.nextElementSibling.classList.remove('text-muted');
        }
      }
    }
    const itemPosition = values.nextElementSibling.nextElementSibling;
    for (const position of itemPosition.children) {
      if (!position.disabled) {
        position.selected = true;
        break;
      }
    }
  }

  const cleanFrom = (selectElement) => {
    const selectedMode = selectElement.querySelector(`option[value="${selectElement.value}"]`);
    const elements = ['villains', 'teamISize', 'teamIISize', 'companionsI', 'companionsII'];
    for (const key of elements) {
      const input = document.querySelector(`[data-set-values="${key}"]`);
      const inputLabel = document.querySelector(`[data-max-values-label="${key}"]`);
      const values = document.querySelectorAll(`[name="${key}"]`);
      input.replaceChildren();
      inputLabel.textContent = selectedMode.dataset[key] || '_';
      input.setAttribute('data-max-values', selectedMode.dataset[key]);
      for (const checkbox of values) {
        checkbox.checked = false;
        checkbox.disabled = false;
        checkbox.nextElementSibling.classList.remove('text-muted');
      }
      if (Number(selectedMode.dataset[key]) == 0) {
        input.classList.add('border-muted');
        input.classList.remove('border-black');
        input.nextElementSibling.classList.add('border-muted', 'text-muted');
        input.nextElementSibling.classList.remove('border-black');
        input.nextElementSibling.disabled = true;
        input.nextElementSibling.nextElementSibling.classList.add('border-muted', 'text-muted');
        input.nextElementSibling.nextElementSibling.classList.remove('border-black');
        input.nextElementSibling.nextElementSibling.disabled = true;
      } else {
        input.classList.remove('border-muted');
        input.classList.add('border-black');
        input.nextElementSibling.classList.remove('border-muted', 'text-muted');
        input.nextElementSibling.classList.add('border-black');
        input.nextElementSibling.disabled = false;
        input.nextElementSibling.nextElementSibling.classList.remove('border-muted', 'text-muted');
        input.nextElementSibling.nextElementSibling.classList.add('border-black');
        input.nextElementSibling.nextElementSibling.disabled = false;
      }
      const childrens = input.nextElementSibling.nextElementSibling.children;
      for (let i = 0; i < childrens.length; i++) {
        childrens[i].selected = (i == 0);
        childrens[i].disabled = Number(selectedMode.dataset[key]) < (i + 1);
      }
    }
    let inputNames = document.querySelectorAll('[data-team-label="teamISize"]');
    for (const inputName of inputNames) {
      inputName.textContent = selectedMode.dataset.teamIISize == 0 ? 'Heores' : 'Blue Team';
    }
    inputNames = document.querySelectorAll('[data-team-label="teamIISize"]');
    for (const inputName of inputNames) {
      inputName.textContent = selectedMode.dataset.teamIISize == 0 ? 'Second' : selectedMode.dataset.villains == 0 ? 'Red' : 'Yellow';
    }
    const villainsSection = document.querySelector('[data-game-builder-section="villains"]');
    if (selectedMode.dataset.villains == 0) {
      villainsSection.classList.add('d-none');
    } else {
      villainsSection.classList.remove('d-none');
    }
    const secondTeamSections = document.querySelectorAll('[data-game-builder-section="second-team"]');
    for (const items of secondTeamSections) {
      if (selectedMode.dataset.teamIISize == 0) {
        items.classList.add('d-none');
      } else {
        items.classList.remove('d-none');
      }
    }
  }

  const getGameFromCode = async () => {
    const errorMessage = document.getElementById('errorMessage');
    errorMessage.classList.add('d-none');
    const errorsInGame = document.getElementById('errorsInGame');
    errorsInGame.lastElementChild.replaceChildren();
    errorsInGame.classList.add('d-none');
    const warningsInGame = document.getElementById('warningsInGame');
    warningsInGame.lastElementChild.replaceChildren();
    warningsInGame.classList.add('d-none');
    const code = document.querySelector('[name="codeInput"]').value;
    if (/^\d+$/.test(code)) {
      screenCoverLoading.classList.remove('d-none');
      try {
        const game = await pc.getGameFromCode(code);
        const notes = await pc.validateGame(game);
        const optionals = await pc.getOptionals(game);
        if (notes.errors.length > 0) {
          for (const note of notes.errors) {
            errorsInGame.lastElementChild.appendChild(elCr("p.m-0", `- ${note}`));
          }
          errorsInGame.classList.remove('d-none');
        }
        if (notes.warnings.length > 0) {
          for (const note of notes.warnings) {
            warningsInGame.lastElementChild.appendChild(elCr("p.m-0", `- ${note}`));
          }
          warningsInGame.classList.remove('d-none');
        }
        cb.buildCard(game, optionals, code, notes);
        screenCoverLoading.classList.add('d-none');
        modalCard.show();
      } catch (error) {
        console.error(error);
        errorMessage.lastElementChild.textContent = 'Error processing code';
        errorMessage.classList.remove('d-none');
      } finally {
        screenCoverLoading.classList.add('d-none');
      }
    } else {
      errorMessage.lastElementChild.textContent = 'Invalid code';
      errorMessage.classList.remove('d-none');
    }
  }

  const getNewGame = async () => {
    const errorMessage = document.getElementById('errorMessage');
    errorMessage.classList.add('d-none');
    const errorsInGame = document.getElementById('errorsInGame');
    errorsInGame.lastElementChild.replaceChildren();
    errorsInGame.classList.add('d-none');
    const warningsInGame = document.getElementById('warningsInGame');
    warningsInGame.lastElementChild.replaceChildren();
    warningsInGame.classList.add('d-none');
    screenCoverLoading.classList.remove('d-none');
    try {
      const code = [];
      const selectElement = document.querySelector('[name="modes"]');
      if (selectElement.value == '-1') {
        errorMessage.lastElementChild.textContent = 'Game mode not chosen.';
        errorMessage.classList.remove('d-none');
        return;
      }
      const selectedMode = selectElement.querySelector(`option[value="${selectElement.value}"]`);
      const villains = [...document.querySelector('[data-set-values="villains"]').querySelectorAll('[data-id]')].sort((a, b) => a.dataset.position - b.dataset.position).map(ele => Number(ele.dataset.id));
      if (villains.length != selectedMode.dataset.villains) {
        errorMessage.lastElementChild.textContent = 'Villains not chosen.';
        errorMessage.classList.remove('d-none');
        return;
      }
      const teamI = [...document.querySelector('[data-set-values="teamISize"]').querySelectorAll('[data-id]')].sort((a, b) => a.dataset.position - b.dataset.position).map(ele => Number(ele.dataset.id));
      if (teamI.length != selectedMode.dataset.teamISize) {
        errorMessage.lastElementChild.textContent = 'Heroes not chosen.';
        errorMessage.classList.remove('d-none');
        return;
      }
      const teamII = [...document.querySelector('[data-set-values="teamIISize"]').querySelectorAll('[data-id]')].sort((a, b) => a.dataset.position - b.dataset.position).map(ele => Number(ele.dataset.id));
      if (teamII.length != selectedMode.dataset.teamIISize) {
        errorMessage.lastElementChild.textContent = 'Heroes not chosen in second team.';
        errorMessage.classList.remove('d-none');
        return;
      }

      code.push(selectedMode.value < 10 ? `0${selectedMode.value}` : `${selectedMode.value}`);
      code.push(`${document.querySelector('input[name="initLocation"]:checked').value - 1}`);
      const locations = [...document.querySelector('[data-set-values="locations"]').querySelectorAll('[data-id]')].reduce((acc, ele) => {acc[ele.dataset.position] = Number(ele.dataset.id); return acc;}, {});
      code.push(6 - Object.keys(locations).length);
      for (let i = 1; i <= 6; i++) {
        if (!locations.hasOwnProperty(i)) {
          code.push(i);
        }
      }
      for (const location in locations) {
        const id = locations[location] || 0;
        code.push(id < 100 ? id < 10 ? `00${id}` : `0${id}` : `${id}`);
      }
      let challenge = document.querySelector('[name="challenges"]').value;
      challenge = challenge == '-1' ? '0': challenge;
      code.push(challenge ? challenge < 10 ? `0${challenge}` : `${challenge}` : '00');
      code.push(villains.length);
      for (let i = 0; i < selectedMode.dataset.villains; i++) {
        code.push(villains[i] < 100 ? villains[i] < 10 ? `00${villains[i]}` : `0${villains[i]}` : `${villains[i]}`);
      }
      const companionsI = [...document.querySelector('[data-set-values="companionsI"]').querySelectorAll('[data-id]')].reduce((acc, ele) => { acc[ele.dataset.position] = Number(ele.dataset.id); return acc; }, {});
      code.push(teamI.length);
      for (let i = 0; i < selectedMode.dataset.teamISize; i++) {
        code.push(teamI[i] < 100 ? teamI[i] < 10 ? `00${teamI[i]}` : `0${teamI[i]}` : `${teamI[i]}`);
        if (companionsI[i+1]) {
          code.push(companionsI[i+1] < 10 ? `0${companionsI[i+1]}` : `${companionsI[i+1]}`);
        } else code.push('00');
      }
      const companionsII = [...document.querySelector('[data-set-values="companionsII"]').querySelectorAll('[data-id]')].reduce((acc, ele) => { acc[ele.dataset.position] = Number(ele.dataset.id); return acc; }, {});
      code.push(teamII.length);
      for (let i = 0; i < selectedMode.dataset.teamIISize; i++) {
        code.push(teamII[i] < 100 ? teamII[i] < 10 ? `00${teamII[i]}` : `0${teamII[i]}` : `${teamII[i]}`);
        if (companionsII[i+1]) {
          code.push(companionsII[i+1] < 10 ? `0${companionsII[i+1]}` : `${companionsII[i+1]}`);
        } else code.push('00');
      }
      const game = await pc.getGameFromCode(code.join(""));
      const notes = await pc.validateGame(game);
      const optionals = await pc.getOptionals(game);
      if (notes.errors.length > 0) {
        for (const note of notes.errors) {
          errorsInGame.lastElementChild.appendChild(elCr("p.m-0", note));
        }
        errorsInGame.classList.remove('d-none');
      }
      if (notes.warnings.length > 0) {
        for (const note of notes.warnings) {
          warningsInGame.lastElementChild.appendChild(elCr("p.m-0", note));
        }
        warningsInGame.classList.remove('d-none');
      }
      cb.buildCard(game, optionals, code.join(""), notes);
      screenCoverLoading.classList.add('d-none');
      modalCard.show();
    } catch (error) {
      console.error(error);
    } finally {
      screenCoverLoading.classList.add('d-none');
    }
  }

  const dowloadImage = async (btn) => {
    screenCoverLoading.classList.remove('d-none');
    const card = document.getElementById('cardGame');
    domtoimage.toBlob(card)
      .then(function (blob) {
        window.saveAs(blob, 'MUCard.png');
        btn.textContent = 'Downloaded!';
      }).catch(error => {
        btn.textContent = 'Couldn\'t dowload card';
        console.error(error);
      });
    screenCoverLoading.classList.add('d-none');
    setTimeout(() => {
      btn.textContent = 'Download card';
    }, 2000);
  }

  const copyCode = async (btn) => {
    const code = document.querySelector('[name="card-code"]');
    code.select();
    code.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(code.value);
    btn.textContent = 'Copied!';
    setTimeout(() => {
      btn.textContent = 'Copy code';
    }, 1500);
  }

  buildPage();
</script>

</html>